{% extends 'padre.html' %}
{% load static %}
{% load django_bootstrap5 %}

{% block title %}{{ titulo_seccion|default:"Crear OP para Stock" }}{% endblock %}

{% block sidebar_content %}
    {% include 'produccion/produccion_sidebar.html' %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 fw-bold text-primary">{{ titulo_seccion|default:"Crear Orden de Producción para Stock" }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'App_LUMINOVA:produccion_stock_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle"></i> Volver al Dashboard
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle"></i> Nueva Orden de Producción para Stock
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>Información:</strong> Esta orden de producción será de tipo "Make to Stock" (MTS) 
                    y no estará vinculada a ninguna orden de venta específica. El producto se agregará al stock del depósito.
                </div>

                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.producto_a_producir.id_for_label }}" class="form-label">
                                    {{ form.producto_a_producir.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.producto_a_producir }}
                                {% if form.producto_a_producir.errors %}
                                    <div class="text-danger">
                                        {{ form.producto_a_producir.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Seleccione el producto que desea producir para stock</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.cantidad_a_producir.id_for_label }}" class="form-label">
                                    {{ form.cantidad_a_producir.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.cantidad_a_producir }}
                                {% if form.cantidad_a_producir.errors %}
                                    <div class="text-danger">
                                        {{ form.cantidad_a_producir.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Cantidad de unidades a producir</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.fecha_inicio_planificada.id_for_label }}" class="form-label">
                                    {{ form.fecha_inicio_planificada.label }}
                                </label>
                                {{ form.fecha_inicio_planificada }}
                                {% if form.fecha_inicio_planificada.errors %}
                                    <div class="text-danger">
                                        {{ form.fecha_inicio_planificada.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Fecha estimada de inicio de producción</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.fecha_fin_planificada.id_for_label }}" class="form-label">
                                    {{ form.fecha_fin_planificada.label }}
                                </label>
                                {{ form.fecha_fin_planificada }}
                                {% if form.fecha_fin_planificada.errors %}
                                    <div class="text-danger">
                                        {{ form.fecha_fin_planificada.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Fecha estimada de finalización</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.sector_asignado_op.id_for_label }}" class="form-label">
                            {{ form.sector_asignado_op.label }}
                        </label>
                        {{ form.sector_asignado_op }}
                        {% if form.sector_asignado_op.errors %}
                            <div class="text-danger">
                                {{ form.sector_asignado_op.errors }}
                            </div>
                        {% endif %}
                        <div class="form-text">Sector responsable de la producción</div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.notas.id_for_label }}" class="form-label">
                            {{ form.notas.label }}
                        </label>
                        {{ form.notas }}
                        {% if form.notas.errors %}
                            <div class="text-danger">
                                {{ form.notas.errors }}
                            </div>
                        {% endif %}
                        <div class="form-text">Notas adicionales sobre la orden de producción</div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'App_LUMINOVA:produccion_stock_dashboard' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Crear Orden de Producción
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Panel de información del producto seleccionado -->
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Información del Producto
                </h6>
            </div>
            <div class="card-body" id="producto-info">
                <p class="text-muted">Seleccione un producto para ver su información de stock.</p>
            </div>
        </div>
        
        <!-- Panel de ayuda -->
        <div class="card border-secondary mt-3">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="bi bi-question-circle"></i> Ayuda
                </h6>
            </div>
            <div class="card-body">
                <h6>¿Qué es una OP para Stock?</h6>
                <p class="small">
                    Las Órdenes de Producción para Stock (MTS - Make to Stock) son órdenes que se crean 
                    para mantener niveles adecuados de inventario, sin estar vinculadas a una venta específica.
                </p>
                
                <h6>Consejos:</h6>
                <ul class="small">
                    <li>Revise los niveles de stock antes de crear la OP</li>
                    <li>Considere la demanda histórica del producto</li>
                    <li>Planifique las fechas considerando la disponibilidad de insumos</li>
                    <li>Asigne el sector apropiado según el tipo de producto</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productoSelect = document.getElementById('{{ form.producto_a_producir.id_for_label }}');
    const cantidadInput = document.getElementById('{{ form.cantidad_a_producir.id_for_label }}');
    const infoPanel = document.getElementById('producto-info');
    
    // Datos de productos (se podrían obtener via AJAX en una implementación más avanzada)
    const productosData = {};
    
    productoSelect.addEventListener('change', function() {
        const productoId = this.value;
        if (productoId) {
            // Aquí se podría hacer una llamada AJAX para obtener la información del producto
            // Por ahora, mostramos información básica
            infoPanel.innerHTML = `
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <span class="ms-2">Cargando información del producto...</span>
            `;
            
            // Simular carga de datos
            setTimeout(() => {
                const productoText = this.options[this.selectedIndex].text;
                infoPanel.innerHTML = `
                    <h6>${productoText}</h6>
                    <p class="small text-muted">
                        <i class="bi bi-box"></i> Producto seleccionado para producción de stock.
                    </p>
                    <div class="alert alert-warning alert-sm">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            Recuerde verificar la disponibilidad de insumos antes de iniciar la producción.
                        </small>
                    </div>
                `;
            }, 500);
        } else {
            infoPanel.innerHTML = '<p class="text-muted">Seleccione un producto para ver su información de stock.</p>';
        }
    });
    
    // Validación de cantidad mínima
    cantidadInput.addEventListener('input', function() {
        const valor = parseInt(this.value);
        if (valor && valor < 1) {
            this.setCustomValidity('La cantidad debe ser mayor a 0');
        } else {
            this.setCustomValidity('');
        }
    });
});
</script>
{% endblock %}
