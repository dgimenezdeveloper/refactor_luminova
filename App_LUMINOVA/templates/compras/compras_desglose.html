{# App_LUMINOVA/templates/compras/compras_desglose.html #}
{% extends 'padre.html' %}
{% load static %}
{% load django_bootstrap5 %}

{% block title %}{{ titulo_seccion|default:"Gestionar Compra por Stock Bajo" }}{% endblock %}

{% block sidebar_content %}
    {% include 'compras/compras_sidebar.html' %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 fw-bold text-primary">{{ titulo_seccion }}</h1>
</div>


<div class="accordion" id="accordionDepositos">
  {% for deposito_nombre, insumos_list in insumos_por_deposito.items %}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading{{ forloop.counter }}">
        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ forloop.counter }}">
          <span class="me-2">
            <i class="bi bi-bell-fill" style="color: #0dcaf0; font-size: 1.2em; vertical-align: middle;"></i>
          </span>
          {{ deposito_nombre }} <span class="badge bg-info ms-2" style="font-size: 1em;">{{ insumos_list|length }}</span>
        </button>
      </h2>
      <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#accordionDepositos">
        <div class="accordion-body">
          <table class="table table-hover table-sm align-middle">
            <thead class="color-thead">
              <tr>
                <th>Insumo</th>
                <th>Categoría</th>
                <th class="text-center">Stock Actual</th>
                <th class="text-center">Acción</th>
              </tr>
            </thead>
            <tbody>
              {% for insumo_item in insumos_list %}
                <tr>
                  <td>
                    {% if insumo_item.imagen %}
                      <img src="{{ insumo_item.imagen.url }}" alt="{{ insumo_item.descripcion }}" style="width: 30px; height: 30px; object-fit: cover; border-radius: 3px; margin-right: 5px;">
                    {% endif %}
                    {{ insumo_item.descripcion|truncatechars:40 }}
                  </td>
                  <td>{{ insumo_item.categoria.nombre|default_if_none:"N/A" }}</td>
                  <td class="text-center fw-bold text-danger">{{ insumo_item.stock }}</td>
                  <td class="text-center">
                    {% if insumo_item.tiene_oc_borrador %}
                      <button class="btn btn-sm btn-secondary" disabled>OC en borrador pendiente</button>
                    {% else %}
                      <a href="{% url 'App_LUMINOVA:compras_seleccionar_proveedor_para_insumo' insumo_item.id %}" 
                         class="btn btn-sm btn-primary" 
                         title="Seleccionar Proveedor para {{ insumo_item.descripcion }}">
                        <i class="bi bi-people-fill"></i> Sel. Proveedor
                      </a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% empty %}
    <p>No hay insumos críticos para gestionar.</p>
  {% endfor %}
</div>

{% if not insumos_por_deposito|length %}
<div class="alert alert-success mt-3" role="alert">
    <i class="bi bi-check-circle-fill"></i> No hay insumos críticos que requieran gestión de compra inmediata (stock ≥ {{ umbral_stock_bajo }} o ya tienen OC en proceso).
</div>
{% endif %}

<div class="mt-4">
    <a href="{% url 'App_LUMINOVA:deposito_view' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left-circle"></i> Volver a Depósito
    </a>
    <a href="{% url 'App_LUMINOVA:compras_lista_oc' %}" class="btn btn-outline-info ms-2">
        <i class="bi bi-list-ul"></i> Ver Todas las Órdenes de Compra
    </a>
</div>
{% endblock %}

{% block scripts_extra %}
<!-- <style>
    /* Puedes mantener tus estilos de .color-thead aquí o en custom.css */
    .color-thead { 
        background-color: #014BAC !important; /* Ejemplo, usa tu color deseado */
        color: white !important;
    }
    /* Estilo para filas de insumos que ya tienen una OC pendiente */
    .table-info-light-custom { 
        background-color: #e6f3ff !important; /* Un azul muy claro */
        /* color: #004085 !important; Si necesitas cambiar el color del texto también */
    }
     .img-thumbnail { /* Si usas esta clase para las imágenes */
        padding: 0.1rem;
    }
</style> -->
{% endblock %}