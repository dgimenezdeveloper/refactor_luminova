{# App_LUMINOVA/templates/compras/compras_desglose.html #}
{% extends 'padre.html' %}
{% load static %}
{% load django_bootstrap5 %}

{% block title %}{{ titulo_seccion|default:"Gestionar Compra por Stock Bajo" }}{% endblock %}

{% block sidebar_content %}
    {% include 'compras/compras_sidebar.html' %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 fw-bold text-primary">{{ titulo_seccion }}</h1>
</div>



<div class="card mt-3">
  <div class="card-header bg-primary text-white">
    <strong>Insumos críticos globales</strong>
  </div>
  <div class="card-body p-0">
    <table class="table table-hover table-sm align-middle mb-0">
      <thead class="color-thead">
        <tr>
          <th>Insumo</th>
          <th>Categoría</th>
          <th class="text-center">Stock Total</th>
          <th class="text-center">Desglose por Depósito</th>
          <th class="text-center">Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for insumo in insumos_criticos_globales %}
        <tr>
          <td>
            {% if insumo.imagen %}
              <img src="{{ insumo.imagen.url }}" alt="{{ insumo.descripcion }}" style="width: 30px; height: 30px; object-fit: cover; border-radius: 3px; margin-right: 5px;">
            {% endif %}
            {{ insumo.descripcion|truncatechars:40 }}
          </td>
          <td>{{ insumo.categoria.nombre|default_if_none:"N/A" }}</td>
          <td class="text-center fw-bold text-danger">{{ insumo.stock_total }}</td>
          <td class="text-center">
            <button class="btn btn-link btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#desglose-{{ insumo.id }}" aria-expanded="false" aria-controls="desglose-{{ insumo.id }}">
              Ver desglose
            </button>
            <div class="collapse mt-2" id="desglose-{{ insumo.id }}">
              <table class="table table-bordered table-sm mb-0">
                <thead>
                  <tr>
                    <th>Depósito</th>
                    <th class="text-center">Stock</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in insumo.desglose_depositos %}
                  <tr>
                    <td>{{ d.deposito }}</td>
                    <td class="text-center">{{ d.stock }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </td>
          <td class="text-center">
            {% if insumo.tiene_oc_borrador %}
              <button class="btn btn-sm btn-secondary" disabled>OC en borrador pendiente</button>
            {% else %}
              <a href="{% url 'App_LUMINOVA:compras_seleccionar_proveedor_para_insumo' insumo.id %}" 
                 class="btn btn-sm btn-primary" 
                 title="Seleccionar Proveedor para {{ insumo.descripcion }}">
                <i class="bi bi-people-fill"></i> Sel. Proveedor
              </a>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-center">No hay insumos críticos para gestionar.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if not insumos_criticos_globales|length %}
<div class="alert alert-success mt-3" role="alert">
    <i class="bi bi-check-circle-fill"></i> No hay insumos críticos que requieran gestión de compra inmediata (stock ≥ {{ umbral_stock_bajo }} o ya tienen OC en proceso).
</div>
{% endif %}

<div class="mt-4">
    <a href="{% url 'App_LUMINOVA:compras_lista_oc' %}" class="btn btn-outline-info ms-2">
        <i class="bi bi-list-ul"></i> Ver Todas las Órdenes de Compra
    </a>
</div>
{% endblock %}

{% block scripts_extra %}
<!-- <style>
    /* Puedes mantener tus estilos de .color-thead aquí o en custom.css */
    .color-thead { 
        background-color: #014BAC !important; /* Ejemplo, usa tu color deseado */
        color: white !important;
    }
    /* Estilo para filas de insumos que ya tienen una OC pendiente */
    .table-info-light-custom { 
        background-color: #e6f3ff !important; /* Un azul muy claro */
        /* color: #004085 !important; Si necesitas cambiar el color del texto también */
    }
     .img-thumbnail { /* Si usas esta clase para las imágenes */
        padding: 0.1rem;
    }
</style> -->
{% endblock %}