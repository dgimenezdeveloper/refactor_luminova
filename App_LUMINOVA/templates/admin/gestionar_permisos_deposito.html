{% extends 'padre.html' %}
{% load static %}

{% block title %}Permisos de Depósito | Luminova{% endblock %}

{% block sidebar_content %}
    {% include 'admin/admin_sidebar.html' %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2 fw-bold text-primary">{{ titulo_seccion }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'App_LUMINOVA:lista_usuarios' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver a Usuarios
        </a>
    </div>
</div>

<div class="alert alert-info">
    <i class="bi bi-info-circle-fill"></i>
    Configure los permisos específicos del usuario <strong>{{ usuario.username }}</strong> para cada depósito.
    Marque los depósitos a los que tendrá acceso y personalice los permisos específicos.
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Permisos por Depósito</h5>
            </div>
            <div class="card-body">
                <form id="permisosForm">
                    {% csrf_token %}
                    <input type="hidden" id="usuario_id" value="{{ usuario.id }}">
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th style="background-color: #014BAC; color: white;">Depósito</th>
                                    <th style="background-color: #014BAC; color: white;">Ubicación</th>
                                    <th style="background-color: #014BAC; color: white;" class="text-center">Tiene Acceso</th>
                                    <th style="background-color: #014BAC; color: white;" class="text-center">Transferencias</th>
                                    <th style="background-color: #014BAC; color: white;" class="text-center">Entradas</th>
                                    <th style="background-color: #014BAC; color: white;" class="text-center">Salidas</th>
                                    <th style="background-color: #014BAC; color: white;" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in todos_depositos %}
                                <tr id="deposito-row-{{ item.deposito.id }}">
                                    <td><strong>{{ item.deposito.nombre }}</strong></td>
                                    <td>{{ item.deposito.ubicacion|default:"Sin ubicación" }}</td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input acceso-checkbox" 
                                                   type="checkbox" 
                                                   id="acceso_{{ item.deposito.id }}"
                                                   data-deposito-id="{{ item.deposito.id }}"
                                                   {% if item.tiene_acceso %}checked{% endif %}>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input permiso-checkbox" 
                                                   type="checkbox" 
                                                   id="transferir_{{ item.deposito.id }}"
                                                   data-deposito-id="{{ item.deposito.id }}"
                                                   data-permiso="transferir"
                                                   {% if item.asignacion and item.asignacion.puede_transferir %}checked{% endif %}
                                                   {% if not item.tiene_acceso %}disabled{% endif %}>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input permiso-checkbox" 
                                                   type="checkbox" 
                                                   id="entradas_{{ item.deposito.id }}"
                                                   data-deposito-id="{{ item.deposito.id }}"
                                                   data-permiso="entradas"
                                                   {% if item.asignacion and item.asignacion.puede_entradas %}checked{% endif %}
                                                   {% if not item.tiene_acceso %}disabled{% endif %}>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input permiso-checkbox" 
                                                   type="checkbox" 
                                                   id="salidas_{{ item.deposito.id }}"
                                                   data-deposito-id="{{ item.deposito.id }}"
                                                   data-permiso="salidas"
                                                   {% if item.asignacion and item.asignacion.puede_salidas %}checked{% endif %}
                                                   {% if not item.tiene_acceso %}disabled{% endif %}>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" 
                                                class="btn btn-sm btn-primary guardar-permiso"
                                                data-deposito-id="{{ item.deposito.id }}"
                                                style="display: none;">
                                            <i class="bi bi-check-lg"></i> Guardar
                                        </button>
                                        <span class="text-success estado-guardado" 
                                              data-deposito-id="{{ item.deposito.id }}"
                                              style="{% if not item.tiene_acceso %}display: none;{% endif %}">
                                            <i class="bi bi-check-circle-fill"></i> Guardado
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Acciones rápidas:</h6>
                                <button type="button" class="btn btn-outline-success btn-sm me-2" id="habilitarTodos">
                                    <i class="bi bi-check-all"></i> Habilitar Todos
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm me-2" id="deshabilitarTodos">
                                    <i class="bi bi-x-circle"></i> Deshabilitar Todos
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" id="permisosCompletos">
                                    <i class="bi bi-shield-check"></i> Permisos Completos
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-light small mb-0">
                                    <strong>Nota:</strong> Los cambios se guardan automáticamente al modificar cada depósito.
                                    <br>• <strong>Transferencias:</strong> Permite mover stock entre depósitos
                                    <br>• <strong>Entradas:</strong> Permite registrar entradas de stock
                                    <br>• <strong>Salidas:</strong> Permite registrar salidas de stock
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Manejar cambios en checkbox de acceso
    document.querySelectorAll('.acceso-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const depositoId = this.dataset.depositoId;
            const tieneAcceso = this.checked;
            const permisosCheckboxes = document.querySelectorAll(`.permiso-checkbox[data-deposito-id="${depositoId}"]`);
            const guardarBtn = document.querySelector(`.guardar-permiso[data-deposito-id="${depositoId}"]`);
            
            // Habilitar/deshabilitar checkboxes de permisos
            permisosCheckboxes.forEach(cb => {
                cb.disabled = !tieneAcceso;
                if (tieneAcceso && !cb.checked) {
                    cb.checked = true; // Marcar todos los permisos por defecto
                }
            });
            
            // Mostrar botón de guardar
            guardarBtn.style.display = tieneAcceso ? 'inline-block' : 'none';
            
            if (tieneAcceso) {
                // Auto-guardar cuando se habilita el acceso
                guardarPermisos(depositoId);
            } else {
                // Auto-guardar cuando se deshabilita el acceso
                guardarPermisos(depositoId);
            }
        });
    });
    
    // Manejar cambios en permisos específicos
    document.querySelectorAll('.permiso-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const depositoId = this.dataset.depositoId;
            const guardarBtn = document.querySelector(`.guardar-permiso[data-deposito-id="${depositoId}"]`);
            guardarBtn.style.display = 'inline-block';
        });
    });
    
    // Manejar botones de guardar
    document.querySelectorAll('.guardar-permiso').forEach(button => {
        button.addEventListener('click', function() {
            const depositoId = this.dataset.depositoId;
            guardarPermisos(depositoId);
        });
    });
    
    // Acciones rápidas
    document.getElementById('habilitarTodos').addEventListener('click', function() {
        document.querySelectorAll('.acceso-checkbox').forEach(cb => {
            if (!cb.checked) {
                cb.checked = true;
                cb.dispatchEvent(new Event('change'));
            }
        });
    });
    
    document.getElementById('deshabilitarTodos').addEventListener('click', function() {
        document.querySelectorAll('.acceso-checkbox').forEach(cb => {
            if (cb.checked) {
                cb.checked = false;
                cb.dispatchEvent(new Event('change'));
            }
        });
    });
    
    document.getElementById('permisosCompletos').addEventListener('click', function() {
        document.querySelectorAll('.acceso-checkbox').forEach(cb => {
            cb.checked = true;
            cb.dispatchEvent(new Event('change'));
        });
    });
    
    function guardarPermisos(depositoId) {
        const usuarioId = document.getElementById('usuario_id').value;
        const tieneAcceso = document.querySelector(`#acceso_${depositoId}`).checked;
        const puedeTransferir = document.querySelector(`#transferir_${depositoId}`).checked;
        const puedeEntradas = document.querySelector(`#entradas_${depositoId}`).checked;
        const puedeSalidas = document.querySelector(`#salidas_${depositoId}`).checked;
        
        const guardarBtn = document.querySelector(`.guardar-permiso[data-deposito-id="${depositoId}"]`);
        const estadoGuardado = document.querySelector(`.estado-guardado[data-deposito-id="${depositoId}"]`);
        
        // Mostrar estado de carga
        guardarBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Guardando...';
        guardarBtn.disabled = true;
        
        fetch("{% url 'App_LUMINOVA:actualizar_permisos_deposito_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'usuario_id': usuarioId,
                'deposito_id': depositoId,
                'tiene_acceso': tieneAcceso,
                'puede_transferir': puedeTransferir,
                'puede_entradas': puedeEntradas,
                'puede_salidas': puedeSalidas
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Ocultar botón de guardar y mostrar estado guardado
                guardarBtn.style.display = 'none';
                estadoGuardado.style.display = 'inline';
                
                // Ocultar estado después de 2 segundos
                setTimeout(() => {
                    estadoGuardado.style.display = 'none';
                }, 2000);
                
                // Mostrar mensaje de éxito
                showToast('success', data.message);
            } else {
                showToast('error', data.error || 'Error al guardar permisos');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', 'Error de conexión');
        })
        .finally(() => {
            // Restaurar botón
            guardarBtn.innerHTML = '<i class="bi bi-check-lg"></i> Guardar';
            guardarBtn.disabled = false;
        });
    }
    
    function showToast(type, message) {
        // Crear toast dinámicamente
        const toastContainer = document.querySelector('.toast-container') || createToastContainer();
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remover toast después de que se oculte
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
        return container;
    }
});
</script>

<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>

{% endblock %}
